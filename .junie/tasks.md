# Current Status

## Thoughts

Make Luny a participatory project.
Build a simple demo game.
Find the (niche) audience who like to build that kind of game but lack the programming expertise.
Show them how simple it is to use.
Build towards their most common requirements.
Ask to contribute their extensions.
Pick (and refactor) the best ones, integrate them into main.
Supervision: educate about the refactorings, play the decisions back.
But also admit to mistakes, shortcomings. 
Be open. Provide perspective.
Repeat.

Ask and thank, shares & patreons.

Help build the "every" engine.
Add a complete feature, or just members you need.
Contribute more services, proxy types, and improvements.
Create LunyScript blocks for learners and creative minds.
LunyEngine grows along with us.
And it doesn't lock us in.
It's ours!

## Next Steps (Sprint)
- [X] Luny: add Variable<T> for all value types
- [X] Luny: create LunyVector2, LunyVector3, LunyQuaternion
- [X] refactor VariableBlock: public API polluted with GetValue(context)
- [X] Design LunyScript: allow non-table variables => ComputedVariableBlock
- [X] LunyScript: create input event API
- [ ] Input: use performed/canceled state and pass this to service base, avoids clearing state
- [ ] Transform => move etc
- 
- [ ] LunyScript: Object.Create().At() <== position or target name
- [ ] LunyScript Time API: create Time blocks returning TimeService values
- [ ] LunyScript: refactor API to extension methods

- [ ] Luny: Variable should understand primitive engine types: Vector2/3, Rect, etc  (no-boxing generic Variable<T>)
  - or quick workaround just for vector types 
  - https://share.google/aimode/g8Apk6pzL1LzLHC2o
- [ ] Luny: Scene unload => should run object destroy cleanup before engine unload event
- 

## Backlog
- ### Post-MVP Refactor
  - Blocks Source Generator: most blocks are trivial and could be autogenerated
  - VariableBlock: refactor to IVariable return type - treat Variable and Variable<T> the same
  - VariableBlocks: remove context from GetValue() - when do we need context, and why?
  - Input: Button IsPressed returns ScriptConditionBlock
  - Input: refactor service base Axis/Vector2 mismatch
  - Object API: remove trailing .Do()
- ### Refactor
  - Consider: LunyEngine explicit Interface Implementations to "hide" Developer SDK methods from public API (beginner-level users) while allowing developers to utilize the SDK features without having to use InternalsVisibleTo. Alternatively: a DeveloperApi, similar to how LunyScript implements its fluent Api.
  - [ ] LunyEngine: consider the registries as service providers - don't pass their references around, instead pass the data, or maybe relay calls via LunyEngine
  - [ ] LunyObjectRegistry: GetByName should use Dictionary, not FirstOrDefault
  - [ ] LunyObjectLifecycle: refactor DestroyNativeNullObjects() to avoid list copy (runs on scene unload)
  - [ ] LunyScriptRunner: make nested class LunyScriptEngine.Observer, forward to LunyScriptBlockRunner + coroutines
  - [ ] LunyScriptRunner: keep or remove the VarHandles for frame/heartbeat counters and elapsed time?
  - [ ] 'MockAssetService' => should be an engine mock, and tested via LunyEngine
  - [ ] ScriptLifecycle/ObjectEventHandler: evaluate, perhaps events should be handled by the runtime context?
- ### Engine Mocks
  - [ ] ..
- ### LunyEngine
  - [ ] Table: allow nested Tables with path-based indexing (dot and/or slash, or multiple indexers: t["1st"]["2nd"])
  - [ ] Table: support array/list variables
  - [ ] Scene Service: implement depth-first enumeration with pre-order or post-order (as IEnumerable?)
  - [ ] Asset Service (Unity): support loading of non-Resource assets (via ScriptableObject DB in Resources)
  - [ ] Asset Service: services initialize placeholders in Dictionary<Type, object> and store them on the Luny side? Release: a single placeholder for any asset type?
  - [ ] Primitives: should have a "WithPhysics()" setting that properly sets up the thing to work physically (Unity: adds Rigidbody, Godot: do the 20 things to make it a working physics object)
  - [ ] Luny: Logger with filterable categories and/or compile flags (ie trace finalizer)
  - [ ] LunyObject: pull down IsNativeObjectValid tests?
  - [ ] Test scene (un-)(re-)load and hook up to scene service callbacks, verify against engine call order (get this first)
- ### LunyScript Design & Lifecycle
  - [ ] ensure deterministic LunyScript execution order (follow scene hierarchy order?)
  - [ ] Handle LunyObject parenting with hierarchy gaps
  - [ ] Review OnIntervalUpdate implementation in script Scheduler and object event handler
  - [ ] How to pass references to blocks via event parameters (eg Scene, "Other" from colliders, etc) => Design
  - [ ] Coroutines: add While condition blocks: While(condition).Do(blocks) (runs while true, replaces For() builder) (hearbeat vs update?)
  - [ ] Coroutines: refactor to step builder with an "options" DTO passed between them, using Interfaces and generics to avoid boxing
  - [ ] LunyScript: design how to edit values in Inspector and apply them to ScriptContext
      - Godot: enable multiple scripts per node!
- ### LunyScript Debug / Profile
  - [ ] Variable validation (log read access of non-existing variables)
  - [ ] Metadata for global variable read/write tracking
- ### LunyScript Blocks & API
  - [ ] LunyScript: Blocks(params blocks) method to create a "Sequence" of blocks. Test if block sequences are clone- and/or reusable: check for any side-effects.
  - [ ] LunyScript: bool IsSingleton property; autocreates object, makes script/object non-destroyable via native feature (DDOL, root node)
  - [ ] [[Event Handling Blocks]] foundation (Input, Collision, SendMessage)
  - [ ] Create Scene load blocks
  - [ ] Implement Random/Shuffle blocks and API
- ### LunyScript Coroutines
  - [ ] Coroutines: re-use existing coroutines for re-created objects/scripts
  - [ ] Variable coroutines, ie runs when variable changes or has a specific value => acts like an event system (though While conditions would cover this already)
  - [ ] add option to disable auto-start of coroutines: DontStart()?
  - [ ] Pause/Start blocks use reference, this introduces a 1-frame delay if ref-call is positioned after coroutine creation => use string based coroutine lookup to work around this?
  - [ ] CoroutineRunner: registry for the coroutine collections
- ### Unity Specific
  - AssetService: load actual prefab asset, current workaround create a "prefab" + "prefab instance" in scene
- ### Godot Specific
  - 
- ### LATER (minor)
  - [ ] consider LunyScript.Every.* (updates) running unconditionally / globally (not tied to object - but then: context?)
  - [ ] LunyScript.Method.Run => could use overloads for When/Every BUT I don't want to make it "too easy" to inject lambdas
  - [ ] Consider: Case insensitive and partial name matching for object-script activator (controlled by LunyScript flags), configurable: starts with/contains/etc
  - [ ] Unity: Add `[IgnoredByDeepProfiler]` attribute to debug methods
- ### EPICS (needs design)
  - LunyScript running on global object (autoload, DDOL) - should still run after scene (re)load
  - [[Lua Integration]] of scripting API
  - **Repository Structure**: LunyEngine as separate package/addon from LunyScript?
  - **Distribution**: versioning of LunyEngine for multiple frameworks? Lightweight package manager?
  - **Hot Reload**: Support for both C# and Lua, manual triggers for testing
  - **Sandboxed Script Execution**: API filter (Lua: blacklist/whitelist, C#: custom sandbox service), object/asset filters
  - **On-Screen Diagnostics**: Display design and required services
  - **Developer SDK Documentation**: Observer patterns, Service API extension, engine support guide, behavioral contracts
  - **Ingame Console**: Run blocks/runnables at runtime via console
  - (maybe) create separate Unity package / Godot addon for in-engine ContractTest verification => figure out how to approach this
  - [ ] Roslyn Generator to inject extension interface properties (base interface: ILunyScriptApi, property: )
      - Should be a incremental generator, using [LunyScriptExtension] and [LunyScriptApi] attributes
      - separate project, compiled to DLL, DLL for both engines
      - Godot generator is installed by modifying .csproj (sticky, ie via plugin.gd)
      - Analyzer message if class isn't partial, but only if it implements a ILunyScriptApi interface
      - `public interface IExtension { ExtensionApi Extension => new(); } // user defined`
      - `public ExtensionApi Extension => ((IExtensionApi)this).Extension; // injected property`
- ### Ideas "Outside Project Scope" ...
  - **Cross-Engine Editor Tooling**: Custom importers, build scripts, editor windows/settings
  - **Portable Scene Format**: Design in Godot, import in Unity, and vice versa (portable asset types)
  - Luny could have a 1-click solution to setting up a git repository for source control. and instructions how to put it in the cloud (github, aws, .. whatever is easy/popular)
  - .. Improve execution speed of git pull/commit script (parallelize? rewrite to non-generic version for better control?)
    - .. auto-pull per solution, so i only need to switch autopull in the solution i don't work in (even automate the switch?? cautions?)
    - .. a proper C# tool instead of 'bush' script?
    - .. a way for me to very quickly get an overview of what's changed, and view the diffs, and perhaps even comment on them

## DONE

### CW08-2026 Feb

### CW07-2026 Feb
- [X] Luny: add Alarm & Stopwatch structs 
- [X] Luny: add Timer & Counter classes 
- [X] Luny: LunyAssetBase as common base class for assets
- [X] Luny: use Dispose() and GC.SuppressFinalize(this) with finalizer logging to catch memory leaks!
- [X] LunyScript: coroutines use Timer/Counter classes
- [X] LunyScriptDefinitionRegistry: fix "already registered" in tests (Assembly shadow copies)
- [X] LunyScript: pass "build context" to Build and return it for settings. Better than property overrides.
- [X] LunyScript: Create Object Lifecycle tests
  - [X] Create/Destroy cycle => should rebuild scripts
  - [X] Create/Destroy cycle => should rebuild coroutines
  - [X] Create scripted object later => should build script or use prebuilt script
  - [X] Create multiple objects with same name 
- [X] Coroutine Improvements:
    - [X] CoroutineBlock: separate Timer/CounterCoroutineBlock subclasses
    - [X] IScriptCoroutineBlock with sub-interfaces => use/return correct types everywhere
    - [X] TimeSlice: internalize time-slicing check, should run in heartbeat or frameupdate dep. on process mode
    - [X] Disallow negative values: In(-10).Frames() => use UInt or throw?
    - [X] Ensure "In(1).Frames" will run in the next frame, and "In(0).Frames" runs in current frame if started in Heartbeat or FrameUpdate
    - [X] Remove PerpetualStyleCounter ... leftover
    - [X] Dangling coroutine builders log and throw
    - [X] Rename ".Build()" to "Do()" in regular Coroutine
- [X] Coroutine Tests: fill gaps in test suite. Verify permutations (including nonsensical => should fail).


### CW06-2026 Feb
- [X] Comprehensive variable tests: split into arithmetic and comparison scripts with separate variables
- [X] Arithmetic tests: add inter-variable operations and complex calculations
- [X] Split variable tests into dedicated files (ArithmeticVariableTests.cs and ComparisonVariableTests.cs)
- [X] Fixed side-effect bug in arithmetic tests (variable overwriting)
- [X] Refactor flow tests to use the Variable API (Var/GVar) instead of GlobalVars/LocalVars directly
- [X] ILunyScriptEngine: hide GetScriptContext from the public interface
- [X] GDSharp: GDScript wrapper following C# guidelines => https://github.com/CodeSmile-0000011110110111/GDSharp
- [X] add LunyScript-Analyzers (Roslyn), always builds release, copies DLL to LunyScript/Analyzers, plugin.gd updates Godot .csproj, and tested working callbacks in Godot + Unity (stub only, no function)
- [X] Rename example engine project repos to "LunyScript_*"
- [X] LunyScript: refactor Api classes to their own files (namespace: LunyScript.Api.DebugApi)
- [X] table.NotifyVariableChanged => move into table ?
- [X] Refactor Table OnValueChanged => move responsibility into VarHandle
- [X] rename: ArithmaticOperationBlockBase (AddVariableBlock); ComparisonBlockBase (IsGreaterVariableBlock)
- [X] VariableConditionBlock: refactor to individual classes
- [X] Variable API: refactor from Var.Add("name", ..) => Var("name").Add/Is(..)
- [X] Variables: complex operations fail => `hp.Sub((hp + 10) / 2)`
- [X] Variables: support `Var("..") > 50` etc
- [X] Variables: support `++` and `--` operators
- [X] Variables: test ! operator
- [X] Variables: Refactor architecture (decoupling) and naming convention
- [X] Variables: Propagate TargetHandle in expressions (bi-directional)
- [X] Variables: Add Const() "readonly" table besides Var/GVar for named constant values (global)
- [X] replace LunyScript.GlobalVars/LocalVars by Var and GVar block-based APIs, and rename to "Variables"
- [X] Refactor When.* API to new proposed On.* API (see [LunyScript_On_vs_When_API_Refactor.md](/RFC/docs/2026-02/LunyScript_On_vs_When_API_Refactor.md))
- [X] [[Coroutine & Timer Blocks]] - see: [LunyScript_CoroutineAndTimer_Design.md](/RFC/docs/2026-02/LunyScript_CoroutineAndTimer_Design.md)
- [X] Coroutine: handle Enabled/Disabled and Destroy events
- [X] CoroutineControlBlock => split into separate classes, one per control action
- [X] CoroutineFinalBuilder => refactor to use fewer ctor params (DTO struct, reusable by coroutine?)
- [X] Repeating timers don't work yet?
- [X] Refactor after implementing timers:
    - System.Threading.Interlocked.Increment => we are single-threaded, remove this
    - [X] timeslice: perhaps defer to specialized subclasses?
    - [X] EveryBuilder: unique name generation with GUID! could be an incrementing static int
    - [X] rename engine event methods (fixedupdate etc) => LunyScriptObjectEventHandler, CoroutineRunner
    - [X] CoroutineBlock => move to Blocks folder
    - [X] TimerBuilder => _isRepeating - is it necessary?
    - [X] CoroutineBuilder: OnUpdate => OnFrameUpdate ?
    - [X] CoroutineInstance: _elapsedCount and _targetCount fields for count-based tracking could be merged with the double types elapsedTime and duration, just advancing in integer steps
        - [X] OR: separate CoroutineInstance types (time, count, time-sliced)
        - [X] AND: reduce logic duplication via template-method in CoroutineBase and progression structs (TimeProgress, CountProgress)
    - [X] CoroutineRunner: Even/Odd could be turned into +0/+1 Delay not carried into logic?
    - [X] LunyScript/Coroutines location: we have Execution and Event subfolders. Check if we should re-organize these types (both folder and naming)
    - [X] perform a complete refactoring pass
        - [X] EveryBuilder
        - [X] TimerBuilder
        - [X] DurationBuilder
        - [X] CoroutineBuilder
        - [X] Coroutine + Base + Config
        - [X] CoroutineRunner
        - [X] CoroutineBlock
- [X] Coroutine: implement OnEnable/OnDisable/OnDestroy behaviour
- [X] CoroutineRunner: use TimeService instead of manually counting update/step
- [X] CoroutineBlock: prevent use in regular sequences
- [X] CounterCoroutine: split into TimeSliceCoroutine for time-sliced variants?
- [X] Luny: refactor "OnObjectDestroyed" fired separately via Lifecycle.OnObjectDestroyed(this); => renamed
- [X] Luny: refactor how time is passed around

### CW05-2026 Jan
- [X] Godot: SceneTree should inherit from MainLoop, with GetMainLoop() returning MainLoop just like Godot
- [X] Godot: Node class' Notification const must be 'long' just like Godot
- [X] Godot: Name property must be of type 'StringName'
- [X] Godot: ensure classes that are require to be 'partial' in Godot have the 'partial' keyword. Add an "empty" partial stub just so the 'partial' keyword sticks when running "code cleanup" (which removes keywords and usings it determines to be superfluous)
- [X] Setup LunyLua and LunyLua-Test with Lua.dll reference
- [X] LunyScriptVariables: renamed to LunyTable
- [X] LunyScriptVariable implementation changes:
    - [X] Rename class to `LunyVariable`, add `ILunyVariable` interface
    - [X] Memory footprint optimization: `Name` returns "(N/A)" in non-debug builds
    - [X] Private constructor, `Create` static methods, updated signature (value first)
- [X] `LunyNumber` struct: wraps a `System.Double` type
    - [X] complete implicit conversion to any other type from byte to long and float and bool ("loss of precision" casts are acceptable)
    - [X] cast to bool: first cast to long, if result is 0 it's 'false', otherwise 'true'
    - [X] add arithmetic operators for bool and string that throw an exception (overrule implicit conversions)
- [X] Variable: refactor to variant type
- [X] Add remaining tests for Table class
- [X] LunyScript: refactor the s_Instance away by changing static subclasses to static struct and assign the instance in Initialize
- [X] [[Conditional Blocks]] (if/else, while, AND/OR/NOT)
- [X] [[Variable Blocks]]
- #### Asset Service ✓
    - [X] Implement Asset/Resource loading by name/path ✓
    - [X] Addressing: LunyUrl/LunyPath: handles resource path conversion & cleanup ie remove "res://") ✓
    - [X] we also need an `AssetID` for LunyEngine internal addressing (indexing) of assets/resources, and mapping to engine-native addressing (ID, GUID, Path) ✓
    - [X] Return valid "error" objects from Asset service ✓
    - [X] Implement loading of "prefabs" (Godot: packedscene, or just any scene?) ✓

### CW04-2026 Jan
- [X] Contract Tests now contain LunyScript tests which should not be there => separate contract from implementation tests
- [X] Move LunyEngine tests from Luny-ContractTest to Luny-Test
- [X] *BridgeTest: should they inherit from ContractTestBase? (YES)
- [X] Remove LunyTestableAttribute (unused, we now have tests in separate projects)
- [X] Check if we can make the native engine projects build by providing Mocks for native APIs (enables engine-wide refactoring!)
- [X] LunyServiceRegistry: refactor engine check, remove adapter and replace with global "engine name" property provided by adapter
- [X] refactor existing *-Test tests:
    - [X] make tests use contract test infrastructure
    - [X] make all tests run once with each engine adapter, without duplicating the test code
    - [X] where it makes sense, move tests to Luny-ContractTest
- [X] GetAllObjects(): change to only convert to LunyObject if scripted
- [X] LunyObject: return cached instance before creating new one
- [X] Implement FindByName (with proxy fallback) for Object.Create that should run a script (consider prebuilt scripts)
- [X] Implement Every.TimeInterval block
- [X] LunyScript.When.Self (updates) should not run while disabled
- [X] Create object via API and register (activate script)
- [X] Get and destroy registered object via API
